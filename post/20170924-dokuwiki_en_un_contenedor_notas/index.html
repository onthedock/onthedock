<!DOCTYPE html>
<html ⚡>
  <head>
    <meta charset="utf-8">
<meta name="pinterest" content="nopin">
<meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1">
<meta name="theme-color" content="#263238">

<meta name="generator" content="Hugo 0.26" />

<link rel="apple-touch-icon" href="https://onthedock.github.io/images/logo.png">


<link rel="canonical" href="https://onthedock.github.io/post/20170924-dokuwiki_en_un_contenedor_notas/">


    
    <link href="https://fonts.googleapis.com/css?family=Lobster|Lato:400,700" rel="stylesheet">
    
    <title>Dokuwiki en un contenedor: notas sobre el proceso - On The Dock</title>
    <style amp-boilerplate>body{-webkit-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-moz-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-ms-animation:-amp-start 8s steps(1,end) 0s 1 normal both;animation:-amp-start 8s steps(1,end) 0s 1 normal both}@-webkit-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-moz-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-ms-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-o-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}</style><noscript><style amp-boilerplate>body{-webkit-animation:none;-moz-animation:none;-ms-animation:none;animation:none}</style></noscript>
    <script async src="https://cdn.ampproject.org/v0.js"></script>
    
    <script async custom-element="amp-twitter" src="https://cdn.ampproject.org/v0/amp-twitter-0.1.js"></script>
<script async custom-element="amp-iframe" src="https://cdn.ampproject.org/v0/amp-iframe-0.1.js"></script>
<script async custom-element="amp-ad" src="https://cdn.ampproject.org/v0/amp-ad-0.1.js"></script>

    
<meta name="description" content="&lt;p&gt;Antes de convertir todas las Raspberry Pi de casa en &lt;em&gt;hosts&lt;/em&gt; de Docker, usaba la Raspberry Pi B&#43; como wiki casero. En él documentaba todo lo que iba aprendiendo sobre las diferentes tecnologías de mi día a día.&lt;/p&gt;&lt;p&gt;Hoy he vuelto a instalar Dokuwiki, aunque esta vez usando un contenedor. En este artículo comento algunos de los puntos relevantes que han surgido durante el proceso.&lt;/p&gt;&lt;p&gt;&lt;/p&gt;">

<meta property="og:title" content="Dokuwiki en un contenedor: notas sobre el proceso - On The Dock">
<meta property="og:type" content="article">
<meta property="og:url" content="https://onthedock.github.io/post/20170924-dokuwiki_en_un_contenedor_notas/">
<meta property="og:image" content="https://onthedock.github.io/images/docker.png">
<meta property="og:site_name" content="On The Dock">
<meta property="og:description" content="&lt;p&gt;Antes de convertir todas las Raspberry Pi de casa en &lt;em&gt;hosts&lt;/em&gt; de Docker, usaba la Raspberry Pi B&#43; como wiki casero. En él documentaba todo lo que iba aprendiendo sobre las diferentes tecnologías de mi día a día.&lt;/p&gt;&lt;p&gt;Hoy he vuelto a instalar Dokuwiki, aunque esta vez usando un contenedor. En este artículo comento algunos de los puntos relevantes que han surgido durante el proceso.&lt;/p&gt;&lt;p&gt;&lt;/p&gt;">
<meta property="og:locale" content="ja_JP">

<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:site" content="On The Dock">
<meta name="twitter:url" content="https://onthedock.github.io/post/20170924-dokuwiki_en_un_contenedor_notas/">
<meta name="twitter:title" content="Dokuwiki en un contenedor: notas sobre el proceso - On The Dock">
<meta name="twitter:description" content="&lt;p&gt;Antes de convertir todas las Raspberry Pi de casa en &lt;em&gt;hosts&lt;/em&gt; de Docker, usaba la Raspberry Pi B&#43; como wiki casero. En él documentaba todo lo que iba aprendiendo sobre las diferentes tecnologías de mi día a día.&lt;/p&gt;&lt;p&gt;Hoy he vuelto a instalar Dokuwiki, aunque esta vez usando un contenedor. En este artículo comento algunos de los puntos relevantes que han surgido durante el proceso.&lt;/p&gt;&lt;p&gt;&lt;/p&gt;">
<meta name="twitter:image" content="https://onthedock.github.io/images/docker.png">


<script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "NewsArticle",
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id":"https://onthedock.github.io/"
    },
    "headline": "Dokuwiki en un contenedor: notas sobre el proceso - On The Dock",
    "image": {
      "@type": "ImageObject",
      "url": "https://onthedock.github.io/images/docker.png",
      "height": 800,
      "width": 800
    },
    "datePublished": "2017-09-24T22:43:01JST",
    "dateModified": "2017-09-24T22:43:01JST",
    "author": {
      "@type": "Person",
      "name": "On The Dock"
    },
    "publisher": {
      "@type": "Organization",
      "name": "On The Dock",
      "logo": {
        "@type": "ImageObject",
        "url": "https://onthedock.github.io/images/logo.png",
        "width": 600,
        "height": 60
      }
    },
    "description": "<p>Antes de convertir todas las Raspberry Pi de casa en <em>hosts</em> de Docker, usaba la Raspberry Pi B+ como wiki casero. En él documentaba todo lo que iba aprendiendo sobre las diferentes tecnologías de mi día a día.</p>

<p>Hoy he vuelto a instalar Dokuwiki, aunque esta vez usando un contenedor. En este artículo comento algunos de los puntos relevantes que han surgido durante el proceso.</p>

<p></p>"
  }
</script>


    <style amp-custom>
      html { font-size: 18px;}@media (max-width: 768px) { html { font-size: 15px; }}body { font-family: Lato,'Hiragino Kaku Gothic Pro',メイリオ,Meiryo,sans-serif; font-size: inherit; margin: 0; color: #263238;}html, body { margin: 0;}a { text-decoration: none; color: #e91e63;}p { margin: 0;}ul,ol { margin: 0; padding: 0;}h1, h2, h3, h4, h5, h6 { margin: 0; font-weight: 700;}h1 { font-size: 1.8rem; line-height: 2rem; margin: 1.5rem 0; }h2 { font-size: 1.4rem; line-height: 2rem; margin: 1.5rem 0; }h3 { font-size: 1.2rem; line-height: 1.5rem; margin: 1.5rem 0; }h4, h5, h6 { font-size: 1rem; line-height: 1.5rem; margin: 1.5rem 0; }.clearfix::after { content: ''; display: block; clear: both;}main { display: block;}/* Layouts */.l-header { padding: .5rem 0; margin-bottom: 2rem; border-bottom: 1px dashed #cfd8dc; text-align: center;}.l-footer { font-size: .8rem; padding: 1rem 0; border-top: 1px dashed #cfd8dc;}.l-footer .copyright-notice,.l-footer .attribution { text-align: center;}.l-container { max-width: 42rem; margin: 0 auto; padding: 0 1rem;}/* Parts:logo */.p-logo { font-family: Lobster, cursive;}.p-logo a { color: #000; font-size: 1.6rem; line-height: 2rem;}/* Parts:section */section { border-top: 2px solid #eceff1; padding: 1.5rem 0;}section>header { text-transform: uppercase; font-weight: 700; margin-bottom: 2rem; text-align: center;}section>header span { display: inline-block; background-color: #000; color: #fff; letter-spacing: 3px; font-size: .7rem; padding: .5rem .75rem;}/* Parts:facts */.p-facts { list-style: none; font-size: .8rem; margin-bottom: 1rem;}.p-facts:last-child { margin-bottom: 0;}.p-facts li { display: inline-block; margin-right: .5rem; text-transform: uppercase;}.p-facts li header { margin-bottom: .25rem; font-weight: 700;}.p-facts li header a { color: #000; text-decoration: underline;}.p-facts li li { display: inline-block; margin-right: .5rem;}.p-facts li li::after { content: ',';}.p-facts li li:last-child::after { content: '';}/* Parts:crumb */.p-crumb { list-style: none; margin-bottom: 1rem; font-size: .8rem; text-transform: uppercase; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;}.p-crumb:last-child { margin-bottom: 0;}.p-crumb li { display: inline;}.p-crumb li::after { content: '›'; margin: 0 .5rem;}.p-crumb li:last-child::after { content: '';}/* Parts:page-title */.p-page-title { margin-bottom: 2rem;}.p-page-title .title { margin-bottom: .5rem;}/* Parts:share */.p-share { margin-bottom: 1.5rem;}.p-share a { display: inline-block; text-align: center; padding: .5rem .5rem; margin-right: .25rem; font-size: .6rem; background-color: #eceff1; font-weight: 700;}.p-share a.ht { color: #00a4de; }.p-share a.fb { color: #3b5998; }.p-share a.tw { color: #1da1f2; }.p-share a.gp { color: #dd4b39; }.p-share a.ln { color: #00c300; }.p-share a.ht::before { content: 'Hatena'; }.p-share a.fb::before { content: 'Facebook'; }.p-share a.tw::before { content: 'Twitter'; }.p-share a.gp::before { content: 'Google+'; }.p-share a.ln::before { content: 'LINE'; }/* Parts:terms */.p-terms { padding-left: 2rem;}/* Parts:paginator */.p-paginator { text-align: center; margin-bottom: 3rem; padding-top: 2rem;}.p-paginator a { display: inline-block; border: 2px solid #eceff1; color: #263238; line-height: 2rem; padding: 0 1rem;}/* Parts:article */.p-articles { list-style: none;}.p-articles>li { margin-bottom: 1.5rem; padding-bottom: 1.5rem; border-bottom: 1px dashed #cfd8dc;}.p-articles>li:last-child { border-bottom: none; padding-bottom: 0;}.p-articles.thin>li { margin-bottom: 1rem; padding-bottom: 1rem;}article .article-header { display: table-cell; height: 6rem; vertical-align: middle;}article .title { margin: 0; margin-bottom: .5rem; font-size: 1.4rem; line-height: 2rem;}article .title a { color: #000;}article .header-wrapper { margin-bottom: 1.5rem;}article .thumbnail { display: block; background-position: center; background-size: cover; background-image: url(https://onthedock.github.io/images/default.jpg); width: 6rem; height: 6rem; border-radius: 50%; box-shadow: 0 0 3px 0 #333 inset; float: left; margin-right: 1rem;}article .summary { margin-bottom: 1.5rem;}article .readmore { text-align: center;}article .readmore a { font-size: .8rem; color: #000; text-decoration: underline;}article.li.sm .header-wrapper { margin-bottom: 0;}.article-body h2 { padding: 1rem 0; color: #55bbbb; border-bottom: 2px solid #eceff1;}.article-body h2:first-child { margin-top: 0; }.article-body h3 { color: #8997e4; font-style: italic;}.article-body h4 { border-left: solid .25rem #cddc39; padding: 0 .5rem;}.article-body p { margin: 1.5rem 0; line-height: 1.5rem;}.article-body a { text-decoration: underline;}.article-body ul,.article-body ol { padding-left: 1.5rem;}.article-body li { line-height: 2rem;}.article-body code { display: inline-block; font-family: Menlo, consolas, monospace; background-color: #eceff1; font-size: .8rem; padding: 0 .5rem; line-height: 1.5rem;}.article-body pre { margin: 1.5rem 0; padding: 1.5rem; font-size: .8rem; background-color: #263238; color: #fff; overflow: auto;}.article-body pre code { background-color: transparent;}.article-body blockquote { /* margin: 1.2rem 0; padding: .5rem 0; */ /*font-size: .8rem;*/ border-top: 1px solid #eceff1; border-bottom: 1px solid #eceff1; color: #607d8b;}.article-body blockquote p { margin: .5rem 0; line-height: 1.5rem;}.article-body strong { /*box-shadow: 0 -.5rem 0 0 #f06292 inset;*/ font-style: bold; font-weight: 700; color: #ff5722;}.article-body em { font-style: normal; /*font-weight: 700;*/ color: #00c300;}.article-body figure { margin: 1.5rem -2rem; }.article-body figure.left,.article-body figure.right { width: 15rem; height: 12rem; margin-top: 0; margin-left: 0; margin-right: 0;}.article-body figure.left { float: left; margin-right: 1rem; margin-left: -2rem; }.article-body figure.right { float: right; margin-left: 1rem; margin-right: -2rem; }@media (max-width: 768px) { .article-body figure { margin: 1.5rem -1rem; } .article-body figure.left, .article-body figure.right { float: none; margin: 0 -1rem; width: auto; height: auto; }}.article-body figcaption { padding: .5rem 0; font-size: .8rem; text-align: center;}.article-body figcaption a { color: #263238;}

       .article-5cc41de3b52937b75f69a54b7698ecda .thumbnail { background-image: url(https://onthedock.github.io/images/docker.png);  }  .article-17f341044c3d14c9654d3c33feb7ac81 .thumbnail { background-image: url(https://onthedock.github.io/images/docker.png);  }  .article-583a77cc8522d685af2babbc4b37048b .thumbnail { background-image: url(https://onthedock.github.io/images/linux.png);  }  .article-9b0b3a180af20b5c091134d23cb6d383 .thumbnail { background-image: url(https://onthedock.github.io/images/minio.jpg);  }  .article-b20735633157cb1e57eb0c1d05406149 .thumbnail { background-image: url(https://onthedock.github.io/images/kubernetes.png);  }  .article-d1e335a06f765bffda53d2e123044b27 .thumbnail { background-image: url(https://onthedock.github.io/images/kubernetes.png);  }  .article-c36c64b9d6ce0d2c95381976831c3160 .thumbnail { background-image: url(https://onthedock.github.io/images/kubernetes.png);  }  .article-ee7d8acecc9de179b9d1cecb3d253215 .thumbnail { background-image: url(https://onthedock.github.io/images/kubernetes.png);  }  .article-2480be47fe45cfc13b07c86c32ed8cda .thumbnail { background-image: url(https://onthedock.github.io/images/kubernetes.png);  }  .article-99a6578fdc273f40a61d182bcb5917c4 .thumbnail { background-image: url(https://onthedock.github.io/images/kubernetes.png);  }  .article-3ffff09a2dd1f953bbb8624d88756829 .thumbnail { background-image: url(https://onthedock.github.io/images/kubernetes.png);  }  .article-0a9cef5c4637bd946188e37439fef69c .thumbnail { background-image: url(https://onthedock.github.io/images/kubernetes.png);  }  .article-42a206d287914317761f7749b964ddb2 .thumbnail { background-image: url(https://onthedock.github.io/images/alpine.png);  }  .article-85dee6c250520e561ebc93740f1d514f .thumbnail { background-image: url(https://onthedock.github.io/images/alpine.png);  }  .article-a65000ba68f97000bb927be3f88f75bd .thumbnail { background-image: url(https://onthedock.github.io/images/kubernetes.png);  }  .article-2de6ff3b0144ea18b2ef056107448a33 .thumbnail { background-image: url(https://onthedock.github.io/images/yaml.png);  }  .article-a8aea2191f0d8d238ab6217feba51ac3 .thumbnail { background-image: url(https://onthedock.github.io/images/vagrant.png);  }  .article-67cd76b76e108b6604b344e92a3c329a .thumbnail { background-image: url(https://onthedock.github.io/images/docker.png);  }  .article-d341a5f8cd54b9da7a3a6d1168365c25 .thumbnail { background-image: url(https://onthedock.github.io/images/kubernetes.png);  }  .article-59e1fe22eaedce05afe517780f87cc98 .thumbnail { background-image: url(https://onthedock.github.io/images/docker.png);  }  .article-87ee3835fe3b255e8566c3bfed2bd38b .thumbnail { background-image: url(https://onthedock.github.io/images/portainer.png);  }  .article-086bb6242700303c8a958c5e74df0ca9 .thumbnail { background-image: url(https://onthedock.github.io/images/docker.png);  }  .article-4c6b9124141ca1a8135b9177248b7e15 .thumbnail { background-image: url(https://onthedock.github.io/images/hugo.png);  }  .article-911698c11286b3ef9eb1a11440c09845 .thumbnail { background-image: url(https://onthedock.github.io/images/kubernetes.png);  }  .article-6a0861472d6f0696079c81e3710d5fe8 .thumbnail { background-image: url(https://onthedock.github.io/images/kubernetes.png);  }  .article-40b8655184d8e4a2ca3650aece49e845 .thumbnail { background-image: url(https://onthedock.github.io/images/kubernetes.png);  }  .article-857a5f627557e7d92f1386f7c6e04dee .thumbnail { background-image: url(https://onthedock.github.io/images/raspberry_pi.png);  }  .article-4db85da082f771e8fb9029adad4173ec .thumbnail { background-image: url(https://onthedock.github.io/images/raspberry_pi.png);  }  .article-b69159ccecf58bff548bbd08481b6e15 .thumbnail { background-image: url(https://onthedock.github.io/images/raspberry_pi.png);  }  .article-da222607e970c37b0b59d8011a2e3398 .thumbnail { background-image: url(https://onthedock.github.io/images/portainer.png);  }  .article-7b36708a64c36890ceb1bf481f3de1fa .thumbnail { background-image: url(https://onthedock.github.io/images/kubernetes.png);  }  .article-d68e08dcca5eafff4ae0d8d06280bf02 .thumbnail { background-image: url(https://onthedock.github.io/images/kubernetes.png);  }  .article-8ff87e4d24c357bbee842dd088ef4cde .thumbnail { background-image: url(https://onthedock.github.io/images/kubernetes.png);  }  .article-d0ca4b0abe6c0c6d22baa800e3fc9935 .thumbnail { background-image: url(https://onthedock.github.io/images/kubernetes.png);  }  .article-63c13529eb1936073e0adc09d7e35b59 .thumbnail { background-image: url(https://onthedock.github.io/images/kubernetes.png);  }  .article-2e821bde62a219fe0b94f62e989269e7 .thumbnail { background-image: url(https://onthedock.github.io/images/docker.png);  }  .article-df564c824db9099fd85c925ad9635cda .thumbnail { background-image: url(https://onthedock.github.io/images/raspberry_pi.png);  }  .article-203d2d443889d9d70ca2ad9abcca49aa .thumbnail { background-image: url(https://onthedock.github.io/images/docker.png);  }  .article-526bade0815ac377e81216604b97c5f7 .thumbnail { background-image: url(https://onthedock.github.io/images/github.png);  }  .article-3d9c586728a0009cb0621b0368120462 .thumbnail { background-image: url(https://onthedock.github.io/images/hugo.png);  }  .article-160ee3ec04bb73e590f125b42640b34b .thumbnail { background-image: url(https://onthedock.github.io/images/hugo.png);  }  .article-c862ac2fb3511b386b4247a80aa6b90b .thumbnail { background-image: url(https://onthedock.github.io/images/linux.png);  }  .article-8a50a2d4216b1a3b2b46c646bd24c5e9 .thumbnail { background-image: url(https://onthedock.github.io/images/linux.png);  }  .article-f027d2889032f918da8e3cc9c03169e0 .thumbnail { background-image: url(https://onthedock.github.io/images/linux.png);  }  .article-6db4ecfe853552466ce5a71b1221a2a0 .thumbnail { background-image: url(https://onthedock.github.io/images/hypriot.png);  } 
    </style>
  </head>

  <body>
    
    
    

    <header class="l-header">
      <div class="l-container">
        <div class="h-logo p-logo">
          <a href="https://onthedock.github.io/" class="h-logo">On The Dock</a>
          <p class="h-logo">Un blog sobre Docker, Kubernetes, DevOps y Raspberry Pi por Xavier Aznar</p>
        </div>
      </div>
    </header>

    <main>
      
<div class="l-container">
  <article class="single article-5cc41de3b52937b75f69a54b7698ecda">
  <div class="header-wrapper">
    <a href="https://onthedock.github.io/post/20170924-dokuwiki_en_un_contenedor_notas/" class="thumbnail" title="Dokuwiki en un contenedor: notas sobre el proceso"></a>
    <header class="article-header">
      <div class="clearfix">
        <h1 class="title">Dokuwiki en un contenedor: notas sobre el proceso</h1>
        <ul class="p-facts">
          <li><time datetime="2017-09-24T22:43:01JST">24 Sep 2017</time></li>
          <li><a href="https://onthedock.github.io/post/">post</a></li>
          
          <li>Xavier Aznar</li>
        </ul>
      </div>
    </header>
  </div>

  <div class="article-body"><p>Antes de convertir todas las Raspberry Pi de casa en <em>hosts</em> de Docker, usaba la Raspberry Pi B+ como wiki casero. En él documentaba todo lo que iba aprendiendo sobre las diferentes tecnologías de mi día a día.</p>

<p>Hoy he vuelto a instalar Dokuwiki, aunque esta vez usando un contenedor. En este artículo comento algunos de los puntos relevantes que han surgido durante el proceso.</p>

<p></p>

<h1 id="un-poco-de-historia">Un poco de historia</h1>

<p>Aquel wiki casero del que hablaba en la intro fue creciendo hasta convertirse en parte de mi <em>memoria extendida</em>: instalé <a href="https://ngrok.com/">Ngrok</a> para poder acceder desde cualquier sitio a la información contenida en el wiki.</p>

<p>Con Ngrok sólo podía crear un túnel hacia la RPi, lo que impedía que mis compañeros de trabajo pudieran consultar el wiki. Ahí fue donde empecé mi andadura con los contenedores, replicando el wiki en Red Hat Cloud: <a href="http://wiki-ameisin.rhcloud.com/">Wiki-Ameisin</a>. Pero tenía dificultades para mantener mi <em>copia local</em>, en la RPi y la <em>copia en la nube</em> (en RHCloud) sincronizadas, por lo que la versión online se fue quedando cada vez más desactualizada.</p>

<p>Después de un cambio de trabajo, el wiki fue perdiendo relevancia hasta que empecé a usar Docker y Kubernetes como <em>hobby</em>. Pero como he canalizado gran parte del aprendizaje hacia este blog, la necesidad de disponer de un wiki  no resultaba apremiante. Además, siempre estaba presente el problema con el almacenamiento (especialmente en Kubernetes, como he comentado en <a href="https://onthedock.github.io/post/170819-usando-un-contenedor-sidecar/">otras</a> <a href="https://onthedock.github.io/post/170817-almacenamiento-en-k8s-problema-abierto/">ocasiones</a>).</p>

<h2 id="problemas-de-concepto">Problemas de <em>concepto</em></h2>

<h3 id="docker-o-kubernetes">Docker o Kubernetes</h3>

<p>Mi objetivo inicial era crear un wiki en Kubernetes. Al no tener resuelto el problema del almacenamiento nativo sobre el clúster, la única vía disponible es la del almacenamiento local (en uno de los nodos) del clúster. Pero eso significa que el <em>pod</em> debe estar ligado al nodo donde se encuentra el almacenamiento.</p>

<p>Aunque se puede conseguir especificando afinidad con uno de los nodos, es más sencillo crear el contenedor en Docker, sin usar el clúster.</p>

<h3 id="un-contenedor-o-varios">Un contenedor o varios</h3>

<p>La filosofía de los contenedores es que cada contenedor debe ejecutar un solo proceso. Así que había pensado en <em>conectar</em> varios contenedores: uno para el servidor web, otro para el <em>middleware</em>, PHP y finalmente otro con los datos. En el caso de Dokuwiki, los datos se almacenan en ficheros de texto plano, por lo que no es necesaria una base de datos o nada por el estilo.</p>

<p>El problema de esta configuración es que el servidor web se ejecuta usando un usuario (por ejemplo <code>www-data</code>), mientras que el contenedor de PHP es probable que use otro usuario&hellip; Cuando he intentado esta configuración en el pasado, he acabado con muchos problemas de permisos.</p>

<p>Así que he seguido el camino inverso y he decidido <em>meterlo todo</em> en un solo contenedor: servidor web, PHP y datos.</p>

<h3 id="configuración-inicial-de-dokuwiki">Configuración inicial de Dokuwiki</h3>

<p>No ha sido difícil crear una imagen base con Nginx, PHP (y PHP-FPM), pero todavía quedaba la parte difícil: configurarlo todo para que funcionase.</p>

<p>He realizado algunas pruebas de configuración de PHP en Nginx, sin éxito.</p>

<p>En cualquier caso, mirando un poco más allá, he pensado que en la primera ejecución del wiki se lanza <code>install.php</code> para configurar el wiki. Si los ficheros se encuentran en la imagen base, no pueden ser modificados, lo que significa que en cada ejecución del wiki se deberían reconfigurar de nuevo.</p>

<p>Sacando los ficheros del contenedor podría solucionarse el problema, por ejemplo creando un contenedor de datos o colocando los ficheros del wiki en un volumen del <em>host</em>.</p>

<p>También habría que apartarse de la <a href="https://www.dokuwiki.org/install:nginx">configuración recomendada del Dokuwiki para Nginx</a>, que entre otras cosas impide el acceso al fichero <code>install.php</code>.</p>

<p>Al final he decidido realizar algunos cambios:</p>

<ul>
<li>usar Caddy, con una <a href="https://github.com/caddyserver/examples/tree/master/dokuwiki">configuración de PHP específica para Dokuwiki</a> más sencilla</li>
<li><em>montar</em> los ficheros de Dokuwiki desde una carpeta en el <em>host</em>.</li>
</ul>

<h3 id="caddy-y-php">Caddy y PHP</h3>

<p>He empezado con un <code>Dockerfile</code> lo más sencillo posible, instalando únicamente lo esencial. He usado <a href="https://bitbucket.org/yobasystems/alpine-caddy/overview">este <code>Dockerfile</code></a> como inspiración.</p>

<p>Inicialmente, sólo instalo Caddy, PHP y las bibliotecas de funciones requeridas por Dokuwiki:</p>

<pre><code class="language-Dockerfile">FROM alpine:3.6

RUN apk add --no-cache caddy php7 php7-fpm php7-gd
</code></pre>

<p>Siguiendo las buenas prácticas de Docker, he decidido usar un usuario <em>no-root</em> llamado <code>caddy</code> (el usuario y el grupo se crear durante la instalación de Caddy).</p>

<p>También he optado por copiar la línea de configuración de <code>php-fpm</code>:</p>

<pre><code class="language-Dockerfile">RUN echo &quot;clear_env = no&quot; &gt;&gt; /etc/php7/php7-fpm.conf

RUN chown -R caddy:caddy /var/www /var/log

WORKDIR /var/www
</code></pre>

<p>Aunque en el <code>Dockerfile</code> se usa la instrucción <code>WORKDIR</code> para cambiar al directorio base que usará Caddy, yo prefiero especificarlo en el fichero de configuración. Aunque en este caso es redundante, he preferido dejarlo para establecer un directorio por defecto para el servidor en la imagen (que quiero utilizar como base para otras aplicaciones basadas en PHP).</p>

<p>A continuación he copiado el fichero de configuración de Caddy y el fichero <code>info.php</code>, que contienen la instrucción <a href="http://php.net/manual/es/function.phpinfo.php"><code>phpinfo();</code></a>.</p>

<p>Para acabar, exponemos el puerto en el que escucha Caddy por defecto, cambiamos al usuario <code>caddy</code> y especificamos el <code>ENTRYPOINT</code> y el <code>CMD</code>:</p>

<pre><code class="language-Dockerfile">EXPOSE 2015
USER caddy
ENTRYPOINT [&quot;/usr/sbin/caddy&quot;]
CMD [&quot;--conf&quot;, &quot;/etc/Caddyfile&quot;]
</code></pre>

<h3 id="fichero-de-configuración-caddyfile">Fichero de configuración <code>Caddyfile</code></h3>

<p>El fichero de configuración de Caddy es mucho más sencillo que el Nginx; sin embargo, he tenido problemas (por no leer la documentación).</p>

<pre><code class="language-Dockerfile">0.0.0.0
root /var/www/wiki
gzip
startup php-fpm7

fastcgi / 127.0.0.1:9000 php {
  index index.php index.htm doku.php
}

log stdout
errors stdout
</code></pre>

<p>Caddy por defecto escucha en el puerto 2015, no en el 80 como suele ser habitual. Esto es fácil de detectar, porque el usuario <code>caddy</code> no tiene permisos para usar un puerto por debajo de 1024. Así que al modificar la primera línea del fichero <code>Caddyfile</code> de <code>0.0.0.0</code> a <code>0.0.0.0:80</code>, el contenedor falla.</p>

<p>He dudado entre usar <code>0.0.0.0</code> o <code>localhost</code>, pero no he observado ninguna diferencia al usar uno u otro -en el contenedor- y al final he dejado <code>0.0.0.0</code>.</p>

<p>Otro punto que me ha tenido bastante <em>ocupado</em> ha sido la línea <code>startup php-fpm</code>. No sabía que <code>php-fpm</code> debía arrancarse, ya que pensaba que se llamaba desde el servidor web cuando hacía falta (para interpretar código php).</p>

<p>La configuración de los parámetros <code>root</code> y <code>fastcgi</code> también me han dado problemas, de nuevo, por no haber leído la documentación. El parámetro <code>root</code> indica a Caddy la ruta en el sistema de ficheros donde encontrar los ficheros a publicar vía web. En <code>fastcgi</code> la ruta es relativa a la URL.</p>

<p>Otro punto que me ha despistado es que el fichero inicial de pruebas <code>index.htm</code> incluye un fragmento de código en PHP, pero que no he conseguido que se interprete (por eso hay una copia del mismo fichero pero con extensión <code>php</code>). Finalmente he podido validar el funcionamiento de Caddy y PHP usando el fichero <code>info.php</code>.</p>

<h2 id="ejecutando-el-contenedor">Ejecutando el contenedor</h2>

<p>Una vez he conseguido crear un contenedor con Caddy y PHP funcional (verificado a partir de <code>$BASEURL/info.php</code>), el siguiente paso era <em>conectarlo</em> con los ficheros de Dokuwiki. La manera más sencilla ha sido creando una carpeta local en la Raspberry Pi y montarla en el contenedor como un volumen.</p>

<p>He descargado y descomprimido la última versión estable de Dokuwiki en la carpeta <code>~/dokuwiki</code> y la he montado en el contenedor:</p>

<pre><code class="language-shell">docker run -d --name wiki -p 8910:2015 -v /home/operador/dokuwiki:/var/www xaviaznar/alpine-caddy-php
</code></pre>

<h3 id="permisos">Permisos</h3>

<p>Como el usuario con el que se ejecuta Caddy en el contenedor no existe en el sistema local, he cambiado los permisos de <code>~/dokuwiki</code> a <code>777</code> (todo el mundo tiene acceso). A diferencia del usuario <code>root</code>, el usuario <code>caddy</code> no existe en el <em>host</em> (en la Raspberry Pi), por lo que no tendría problemas para &ldquo;salir&rdquo; de la carpeta <code>dokuwiki</code> y acceder a otras partes del sistema más sensibles.</p>

<h3 id="librerías-adicionales">Librerías adicionales</h3>

<p>Dado que he optado por reducir al mínimo las <em>librerías</em> de PHP incluidas en el contenedor, al arrancar Dokuwiki he encontrado algunos errores en el funcionamiento del mismo.</p>

<p>Al final, he tenido que añadir <code>php7-session php7-xm</code> para arrancar Dokuwiki sin errores, y <code>php7-openssl php7-zlib</code> cuando he intentado añadir <em>plugins</em>, con lo que la línea definitiva en el <code>Dockerfile</code> ha quedado:</p>

<pre><code class="language-Dockerfile">RUN apk add --no-cache caddy php7 php7-fpm php7-gd \
    php7-session php7-xml php7-openssl php7-zlib
</code></pre>

<h2 id="ficheros-auxiliares">Ficheros auxiliares</h2>

<p>Dado que todo el proceso por el que he pasado ha sido el resultado de innumerables iteraciones, en cierto punto he decidido <em>automatizar</em> parte del proceso.</p>

<p>He creado unos scripts auxiliares para construir la imagen, parar y eliminar el contenedor y para ejecutarlo de nuevo. Para poder conectar al contenedor y revisar la configuración, la correcta ubicación de los ficheros (o si el proceso <code>php-fpm</code> estaba funcionando), también he credo un script para conectar al contenedor y ejecutar una terminal.</p>

<p>Obviamente dista mucho de ser un <em>pipeline</em> de integración continua, pero es un primer paso en la dirección correcta ;)</p></div>

  <aside class="p-share">
  <a href="http://b.hatena.ne.jp/add?mode=confirm&url=https%3a%2f%2fonthedock.github.io%2fpost%2f20170924-dokuwiki_en_un_contenedor_notas%2f&title=Dokuwiki%20en%20un%20contenedor%3a%20notas%20sobre%20el%20proceso" title="はてなブックマーク" class="ht" target="_blank" rel="nofollow"></a>
  <a href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fonthedock.github.io%2fpost%2f20170924-dokuwiki_en_un_contenedor_notas%2f&t=Dokuwiki%20en%20un%20contenedor%3a%20notas%20sobre%20el%20proceso" title="Facebookでシェア" class="fb" target="_blank" rel="nofollow"></a>
  <a href="http://twitter.com/intent/tweet?url=https%3a%2f%2fonthedock.github.io%2fpost%2f20170924-dokuwiki_en_un_contenedor_notas%2f&text=Dokuwiki%20en%20un%20contenedor%3a%20notas%20sobre%20el%20proceso&tw_p=tweetbutton" title="Twitterでシェア" class="tw" target="_blank" rel="nofollow"></a>
  <a href="https://plus.google.com/share?url=https%3a%2f%2fonthedock.github.io%2fpost%2f20170924-dokuwiki_en_un_contenedor_notas%2f" title="Google Plusでシェア" class="gp" target="_blank" rel="nofollow"></a>
  <a href="http://line.me/R/msg/text/?Dokuwiki%20en%20un%20contenedor%3a%20notas%20sobre%20el%20proceso https%3a%2f%2fonthedock.github.io%2fpost%2f20170924-dokuwiki_en_un_contenedor_notas%2f" title="LINEでシェア" class="ln" target="_blank" rel="nofollow"></a>
</aside>


  <footer class="article-footer">
    <section>
      <ol class="p-crumb">
        <li><a href="https://onthedock.github.io/">On The Dock</a></li>
        
        <li itemscope="" itemtype="http://data-vocabulary.org/Breadcrumb"><a href="https://onthedock.github.io/post/" itemprop="url"><span itemprop="title">post</span></a></li>
        
        <li>Dokuwiki en un contenedor: notas sobre el proceso</li>
      </ol>

      
      
      
      <ul class="p-facts">
        <li>
          <header><a href="https://onthedock.github.io/categories/">categories</a></header>
          <ul>
            
            <li><a href="https://onthedock.github.io/categories/dev/">dev</a></li>
            
          </ul>
        </li>
      </ul>
      
      
      
      <ul class="p-facts">
        <li>
          <header><a href="https://onthedock.github.io/tags/">tags</a></header>
          <ul>
            
            <li><a href="https://onthedock.github.io/tags/linux/">linux</a></li>
            
            <li><a href="https://onthedock.github.io/tags/alpine/">alpine</a></li>
            
            <li><a href="https://onthedock.github.io/tags/docker/">docker</a></li>
            
            <li><a href="https://onthedock.github.io/tags/dokuwiki/">dokuwiki</a></li>
            
          </ul>
        </li>
      </ul>
      
      
    </section>
  </footer>
</article>



  
  
  <section>
    <header><span>Latests</span></header>
    <ul class="p-articles thin">
      <li><article class="li sm article-17f341044c3d14c9654d3c33feb7ac81">
  <div class="header-wrapper">
    <a href="https://onthedock.github.io/post/20170920-autoarranque-de-contenedores/" class="thumbnail" title="Cómo arrancar contenedores durante el inicio del sistema"></a>
    <header class="article-header">
      <div class="clearfix">
        <h2 class="title"><a href="https://onthedock.github.io/post/20170920-autoarranque-de-contenedores/">Cómo arrancar contenedores durante el inicio del sistema</a></h2>
        <ul class="p-facts">
          <li><time datetime="2017-09-20T22:09:46JST">20 Sep 2017</time></li>
          <li><a href="https://onthedock.github.io/post/">post</a></li>
          
        </ul>
      </div>
    </header>
  </div>
</article>
</li><li><article class="li sm article-583a77cc8522d685af2babbc4b37048b">
  <div class="header-wrapper">
    <a href="https://onthedock.github.io/post/20170827-dnsmasq-en-docker/" class="thumbnail" title="dnsmasq en Docker"></a>
    <header class="article-header">
      <div class="clearfix">
        <h2 class="title"><a href="https://onthedock.github.io/post/20170827-dnsmasq-en-docker/">dnsmasq en Docker</a></h2>
        <ul class="p-facts">
          <li><time datetime="2017-08-27T20:48:02JST">27 Aug 2017</time></li>
          <li><a href="https://onthedock.github.io/post/">post</a></li>
          
        </ul>
      </div>
    </header>
  </div>
</article>
</li><li><article class="li sm article-9b0b3a180af20b5c091134d23cb6d383">
  <div class="header-wrapper">
    <a href="https://onthedock.github.io/post/170820-probando-minio/" class="thumbnail" title="Probando Minio"></a>
    <header class="article-header">
      <div class="clearfix">
        <h2 class="title"><a href="https://onthedock.github.io/post/170820-probando-minio/">Probando Minio</a></h2>
        <ul class="p-facts">
          <li><time datetime="2017-08-20T21:28:20JST">20 Aug 2017</time></li>
          <li><a href="https://onthedock.github.io/post/">post</a></li>
          
        </ul>
      </div>
    </header>
  </div>
</article>
</li><li><article class="li sm article-b20735633157cb1e57eb0c1d05406149">
  <div class="header-wrapper">
    <a href="https://onthedock.github.io/post/170819-usando-un-contenedor-sidecar/" class="thumbnail" title="Usando un contenedor sidecar para el almacenamiento"></a>
    <header class="article-header">
      <div class="clearfix">
        <h2 class="title"><a href="https://onthedock.github.io/post/170819-usando-un-contenedor-sidecar/">Usando un contenedor sidecar para el almacenamiento</a></h2>
        <ul class="p-facts">
          <li><time datetime="2017-08-19T09:51:23JST">19 Aug 2017</time></li>
          <li><a href="https://onthedock.github.io/post/">post</a></li>
          
        </ul>
      </div>
    </header>
  </div>
</article>
</li>
    </ul>
  </section>
  
</div>


    </main>

    

    <footer class="l-footer">
      <div class="l-container">
        <p class="copyright-notice">Handmade with &#9829; by Xavi Aznar</p>
        <aside>
          <p class="attribution">Powered by <a href="https://gohugo.io/">Hugo</a> using <a href="https://github.com/dim0627/hugo_theme_aglaus" class="h-logo">Aglaus</a> (designed by <a href="http://yet.unresolved.xyz/">Daisuke Tsuji</a>).</p>
        </aside>
      </div>
    </footer>

    <a href="#" class="p-movetop" title="ページ上部へ戻る" rel="nofollow"></a>
  </body>
</html>

